$N_RUN = 10

$RANDOM = misc.sharedRG()

$MLP = ds.num.mlp(innerLayerRatio = 2; nOfInnerLayers = 1)

$QUALITY_F1 = ds.e.pong.shiftedScoreDiff1()
$QUALITY_F2 = ds.e.pong.shiftedScoreDiff2()

$SIMULATION = ds.bat.fromEnvironment(
  environment = ds.e.pong(racketsInitialYRange = m.range(min=25.0;max=25.0); randomGenerator=$RANDOM);
  stopCondition = predicate.not(condition = predicate.always())
)

$OPPONENT = ds.opponent.pong.simple()

$PONG_PROBLEM = ea.p.biSimToTo(
  simulation = $SIMULATION;
  qFunction = $QUALITY_F1;
  trainingOpponent = m.supplier(of = ds.opponent.pong.simple());
  type = maximize
)

$PONG_BI_PROBLEM = ea.p.biSimToBiTo(
  simulation = $SIMULATION;
  qFunction1 = $QUALITY_F1;
  qFunction2 = $QUALITY_F2;
  type = maximize
)

$BRAIN_EXTRACTOR = ea.f.solution()

$VS_SELF = ds.f.selfBiSimulator(
  of = ea.f.solution();
  tRange = misc.range(min = 0; max = 45);
  dT = 0.05;
  simulation = $SIMULATION
)

$VS_OPPONENT = ds.f.opponentBiSimulator(
  of = ea.f.solution();
  opponent = $OPPONENT;
  tRange = misc.range(min = 0; max = 45);
  dT = 0.05;
  simulation = $SIMULATION
)

$THRESHOLD = 0.5
$NEG_THRESHOLD = -0.5

$TREE_DESCRIPTOR = [
  ea.s.me.d.descriptor(f = ea.f.treeSize(of = ea.f.genotype()); min = 0; max = 250; nOfBins = 10);
  ea.s.me.d.descriptor(f = f.size(of = f.filter(of = ea.f.treeLeaves(of = ea.f.genotype()); condition = predicate.matches(f = f.toString(); regex = "i[0-9]+"))); min = 0; max = 30; nOfBins = 10)
]

$ANN_DESCRIPTORS = [
  ea.s.me.d.descriptor(
    f = f.mathOp(
      op = divide;
      args = [
        f.size(of = f.filter(
          of = f.flat(of = f.nTh(of = ds.f.weights(of = $BRAIN_EXTRACTOR); n = 0));
          condition = predicate.all(conditions = [predicate.lt(t = $THRESHOLD); predicate.gt(t = $NEG_THRESHOLD)])
        ));
        f.size(
          of = f.flat(of = f.nTh(of = ds.f.weights(of = $BRAIN_EXTRACTOR); n = 0))
        )
      ]
    );
    min = 0.0;
    max = 1.0;
    nOfBins = 8
  );
  ea.s.me.d.descriptor(
    f = f.mathOp(
      op = divide;
      args = [
        f.size(of = f.filter(
          of = f.flat(of = f.nTh(of = ds.f.weights(of = $BRAIN_EXTRACTOR); n = 1));
          condition = predicate.all(conditions = [predicate.lt(t = $THRESHOLD); predicate.gt(t = $NEG_THRESHOLD)])
        ));
        f.size(
          of = f.flat(of = f.nTh(of = ds.f.weights(of = $BRAIN_EXTRACTOR); n = 1))
        )
      ]
    );
    min = 0.0;
    max = 1.0;
    nOfBins = 8
  )
]

$VSR_BODY_DESCRIPTORS = [
  ea.s.me.d.descriptor(f = f.gridCount(of = s.f.vsrBody(of = ea.f.supplied(of = ea.f.solution()))); min = 1; max = 16; nOfBins = 8);
  ea.s.me.d.descriptor(f = f.gridElongation(of = s.f.vsrBody(of = ea.f.supplied(of = ea.f.solution()))); min = 0; max = 1; nOfBins = 8)
]

$GENERAL_LISTENERS = [

  ea.l.console(
    kFunctions = [
      f.replaceAll(of = f.interpolated(name = "solver-name"; s = "{run.solver.name}-{run.solver.opponentsSelector.name}"); regex="^(.*?)(?:-null)*$")
    ];
    eFunctions = [
      f.timestamp();
      ea.f.size(of = ea.f.genotype(of = ea.f.best()); format = "%3d");
      ea.f.quality(of = ea.f.best(); format = "%4.1f")
    ]
  );

  ea.listener.allCsv(
    path = "../results/{name}/{startTime}/last-generations.csv";
    runFunctions = [
      f.replaceAll(of = f.interpolated(name = "solver-name"; s = "{run.solver.name}-{run.solver.opponentsSelector.name}"); regex="^(.*?)(?:-null)*$");
      f.mappableKey(key = "run.problem.simulation.environment");
      f.mappableKey(key = "run.solver.mapper")
    ];
    individualFunctions = [
      f.timestamp();
      f.toBase64(of = ea.f.genotype());
      ea.f.quality()
    ];
    onlyLast = true
  );

  ea.l.csv(
    path = "../results/{name}/{startTime}/last-generations-bests.csv";
    kFunctions = [
      f.replaceAll(of = f.interpolated(name = "solver-name"; s = "{run.solver.name}-{run.solver.opponentsSelector.name}"); regex="^(.*?)(?:-null)*$");
      f.mappableKey(key = "run.problem.simulation.environment");
      f.mappableKey(key = "run.solver.mapper")
    ];
    eFunctions = [
      f.timestamp();
      f.toBase64(of = ea.f.genotype(of = ea.f.best()));
      ea.f.quality(of = ea.f.best())
    ];
    onlyLast = true
  );

  ea.l.savePlotAndCsvForExp(
    path = "../results/{name}/{startTime}/best-q.svg";
    plot = ea.plot.multi.quality(
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{run.solver.name}-{run.solver.opponentsSelector.name}"); regex="^(.*?)(?:-null)*$")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForExp(
    deferred = true;
    path = "../results/{name}/{startTime}/best-vs-self.svg";
    plot = ea.plot.multi.xyExp(
      y = f.composition(of = f.composition(of = ea.f.best(); then = $VS_SELF); then = $QUALITY_F1);
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{run.solver.name}-{run.solver.opponentsSelector.name}"); regex="^(.*?)(?:-null)*$")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForExp(
    deferred = true;
    path = "../results/{name}/{startTime}/best-vs-opponent.svg";
    plot = ea.plot.multi.xyExp(
      y = f.composition(of = f.composition(of = ea.f.best(); then = $VS_OPPONENT); then = $QUALITY_F1);
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{run.solver.name}-{run.solver.opponentsSelector.name}"); regex="^(.*?)(?:-null)*$")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForExp(
    path = "../results/{name}/{startTime}/avg-q.svg";
    plot = ea.plot.multi.xyExp(
      y = f.avg(of = f.each(mapF = ea.f.quality(); of = ea.f.all()));
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{run.solver.name}-{run.solver.opponentsSelector.name}"); regex="^(.*?)(?:-null)*$")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForExp(
    deferred = true;
    path = "../results/{name}/{startTime}/avg-vs-self.svg";
    plot = ea.plot.multi.xyExp(
      y = f.avg(of = f.each(mapF = f.composition(of = f.composition(then = $VS_SELF); then = $QUALITY_F1); of = ea.f.all()));
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{run.solver.name}-{run.solver.opponentsSelector.name}"); regex="^(.*?)(?:-null)*$")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForExp(
    deferred = true;
    path = "../results/{name}/{startTime}/avg-vs-opponent.svg";
    plot = ea.plot.multi.xyExp(
      y = f.avg(of = f.each(mapF = f.composition(of = f.composition(then = $VS_OPPONENT); then = $QUALITY_F1); of = ea.f.all()));
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{run.solver.name}-{run.solver.opponentsSelector.name}"); regex="^(.*?)(?:-null)*$")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForRun(
    path = "../results/{name}/{startTime}/archive-{run.problem.name}-{run.solver.name}-{run.solver.opponentsSelector.name}-{run.randomGenerator.seed:%02d}.svg";
    plot = ea.plot.single.me(
      title = f.replaceAll(of = f.interpolated(name = "title"; s = "Archive of {run.solver.name}-{run.solver.opponentsSelector.name} on {run.problem.name} (seed={run.randomGenerator.seed})"); regex="^(.*?)(?:-null)*$")
    );
    kCondition = predicate.matches(f = f.mappableKey(key = "run.solver.name"); regex = ".*-me-.*");
    type = svg
  )

]

$PONG_LISTENERS = [
  ea.l.saveForRun(
    of = ea.acc.lastBest();
    processor = viz.f.toVideo(
      video = ea.misc.toVideo(drawer = ds.d.pong());
      of = $VS_SELF
    );
    path = "../results/{name}/{startTime}/best-vs-self-{run.solver.name}-{run.solver.opponentsSelector.name}-{run.randomGenerator.seed:%02d}";
    kCondition = $VIDEO
  )
]

$SUMO_LISTENERS =[
  ea.l.saveForRun(
    of = ea.acc.lastBest();
    processor = f.composition(
      of = f.pairerFirst(of = ea.f.solution(); second = m.supplier(of = s.a.dummyBox()));
      then = sim.biTaskVideoBuilder(
        drawer = sim.drawer(framer = sim.staticFramer(minX = 4; maxX = 36; minY = 3; maxY = 24); actions = true);
        task = $SIMULATION
      )
    );
    path = "../results/{name}/{startTime}/best-vs-box-{run.solver.name}-{run.solver.opponentsSelector.name}-{run.randomGenerator.seed:%02d}.mp4";
    kCondition = $VIDEO
  )
]

ea.experiment(
  runs =
    (randomGenerator = (seed = $SEEDS) * [m.defaultRG()]) *
    (solver = (stop = [ea.sc.nOfQualityEvaluations(n = $N_EVALS)]) *
    (fitnessReducer = [ea.misc.lossyAverage()]) * (opponentsSelector = (nOfOpponents = [1; 2; 3]) * [ea.misc.nearestMESelector(); ea.misc.randomSelector(); ea.misc.farthestMESelector(); ea.misc.bestSelector(); ea.misc.oldestSelector()]) * (emptyArchive = [false]) * [
      ea.s.biMapElites(
        name = "bi-me-tree";
        representation = ea.r.srTree();
        mapper = ea.m.nurfToNds(of = ea.m.srTreeToNurf());
        descriptors = $TREE_DESCRIPTOR;
        fitnessAggregator = f.avg()
      );
      ea.s.biMapElites(
        name = "bi-me-ann";
        representation = ea.r.doubleString();
        mapper = ea.m.dsToNpnds(npnds = $MLP);
        descriptors = $ANN_DESCRIPTORS;
        fitnessAggregator = f.avg()
      )
    ] + [
      ea.s.ga(
        name = "self-ga-tree";
        representation = ea.r.srTree();
        mapper = ea.m.nurfToNds(of = ea.m.srTreeToNurf())
      );
      ea.s.ga(
        name = "self-ga-ann";
        representation = ea.r.doubleString();
        mapper = ea.m.dsToNpnds(npnds = $MLP)
      );

      ea.s.mapElites(
        name = "self-me-ann";
        representation = ea.r.doubleString();
        mapper = ea.m.dsToNpnds(npnds = $MLP);
        descriptors = $ANN_DESCRIPTORS
      );
      ea.s.mapElites(
        name = "self-me-tree";
        representation = ea.r.srTree();
        mapper = ea.m.nurfToNds(of = ea.m.srTreeToNurf());
        descriptors = $TREE_DESCRIPTOR
      )
    ] + (fitnessReducer = [ea.misc.lossyAverage()]) * (opponentsSelector = (nOfOpponents = [1; 2; 3]) *
    [ea.misc.randomSelector(); ea.misc.bestSelector(); ea.misc.oldestSelector()]) * [
      ea.s.biGa(
        name = "bi-ga-ann";
        representation = ea.r.doubleString();
        mapper = ea.m.dsToNpnds(npnds = $MLP);
        fitnessAggregator = f.avg()
      );
      ea.s.biGa(
        name = "bi-ga-tree";
        representation = ea.r.srTree();
        mapper = ea.m.nurfToNds(of = ea.m.srTreeToNurf());
        fitnessAggregator = f.avg()
      )
    ]) *
    (problem = [ea.p.biSimToBiTo(
      simulation = $SIMULATION;
      qFunction1 = $QUALITY_F1;
      qFunction2 = $QUALITY_F2;
      tRange = misc.range(min = 0; max = 45);
      dT = 0.05;
      type = maximize
    )]) *
    [ea.run()];

  listeners = $GENERAL_LISTENERS + $PONG_LISTENERS
)