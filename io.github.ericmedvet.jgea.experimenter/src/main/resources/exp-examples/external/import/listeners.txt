$basePath = ''../results/{^^.name}/{^^.startTime}/''

$GENERAL_LISTENERS = [

  ea.l.console(
    kFunctions = [
      f.replaceAll(of = f.interpolated(name = "solver-name"; s = "{solver.name}-{solver.opponentsSelector.name}"); regex="-null")
    ];
    eFunctions = [
      f.timestamp();
      ea.f.size(of = ea.f.genotype(of = ea.f.best()); format = "%3d");
      ea.f.quality(of = ea.f.best(); format = "%4.1f")
    ]
  );

  ea.listener.allCsv(
    path = $basePath + "last-generations.csv";
    runFunctions = [
      f.replaceAll(of = f.interpolated(name = "solver-name"; s = "{solver.name}-{solver.opponentsSelector.name}"); regex="-null");
      f.mappableKey(key = "problem.simulation.environment");
      f.mappableKey(key = "solver.mapper")
    ];
    individualFunctions = [
      f.timestamp();
      f.toBase64(of = ea.f.genotype());
      ea.f.quality()
    ];
    onlyLast = true
  );

  ea.l.csv(
    path = $basePath + "last-generations-bests.csv";
    kFunctions = [
      f.replaceAll(of = f.interpolated(name = "solver-name"; s = "{solver.name}-{solver.opponentsSelector.name}"); regex="-null");
      f.mappableKey(key = "problem.simulation.environment");
      f.mappableKey(key = "solver.mapper")
    ];
    eFunctions = [
      f.timestamp();
      f.toBase64(of = ea.f.genotype(of = ea.f.best()));
      ea.f.quality(of = ea.f.best())
    ];
    onlyLast = true
  );

  ea.l.savePlotAndCsvForExp(
    path = $basePath + "best-q.svg";
    plot = ea.plot.multi.quality(
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.name}"); regex="-null");
      xSubplot = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.nOfOpponents}");
      ySubplot = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.name}"); regex = "\[[0-9]\]")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForExp(
    deferred = true;
    path = $basePath + "best-vs-self.svg";
    plot = ea.plot.multi.xyExp(
      y = f.composition(of = f.composition(of = ea.f.best(); then = $VS_SELF); then = $QUALITY_F1);
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.name}"); regex="-null");
      xSubplot = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.nOfOpponents}");
      ySubplot = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.name}"); regex = "\[[0-9]\]")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForExp(
    deferred = true;
    path = $basePath + "best-vs-opponent.svg";
    plot = ea.plot.multi.xyExp(
      y = f.composition(of = f.composition(of = ea.f.best(); then = $VS_OPPONENT); then = $QUALITY_F1);
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.name}"); regex="-null");
      xSubplot = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.nOfOpponents}");
      ySubplot = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.name}"); regex = "\[[0-9]\]")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForExp(
    path = $basePath + "avg-q.svg";
    plot = ea.plot.multi.xyExp(
      y = f.avg(of = f.each(mapF = ea.f.quality(); of = ea.f.all()));
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.name}"); regex="-null");
      xSubplot = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.nOfOpponents}");
      ySubplot = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.name}"); regex = "\[[0-9]\]")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForExp(
    deferred = true;
    path = $basePath + "avg-vs-self.svg";
    plot = ea.plot.multi.xyExp(
      y = f.avg(of = f.each(mapF = f.composition(of = f.composition(then = $VS_SELF); then = $QUALITY_F1); of = ea.f.all()));
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.name}"); regex="-null");
      xSubplot = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.nOfOpponents}");
      ySubplot = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.name}"); regex = "\[[0-9]\]")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForExp(
    deferred = true;
    path = $basePath + "avg-vs-opponent.svg";
    plot = ea.plot.multi.xyExp(
      y = f.avg(of = f.each(mapF = f.composition(of = f.composition(then = $VS_OPPONENT); then = $QUALITY_F1); of = ea.f.all()));
      line = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.name}"); regex="-null");
      xSubplot = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.nOfOpponents}");
      ySubplot = f.replaceAll(of = f.interpolated(name = "solver"; s = "{solver.opponentsSelector.name}"); regex = "\[[0-9]\]")
    );
    overwrite = true;
    type = svg
  );

  ea.l.savePlotAndCsvForRun(
    path = $basePath + "archive-{problem.name}-{solver.name}-{solver.opponentsSelector.name}-{randomGenerator.seed:%02d}.svg";
    plot = ea.plot.single.me(
      title = f.replaceAll(of = f.interpolated(name = "title"; s = "Archive of {solver.name}-{solver.opponentsSelector.name} on {problem.name} (seed={randomGenerator.seed})"); regex="-null")
    );
    kCondition = predicate.matches(f = f.mappableKey(key = "solver.name"); regex = ".*-me-.*");
    type = svg
  )

]

$PONG_LISTENERS = [
  ea.l.saveForRun(
    of = ea.acc.lastBest();
    processor = viz.f.toVideo(
      video = ea.misc.toVideo(drawer = ds.d.pong());
      of = $VS_SELF
    );
    path = $basePath + "best-vs-self-{solver.name}-{solver.opponentsSelector.name}-{randomGenerator.seed:%02d}";
    kCondition = $VIDEO
  )
]

$SUMO_LISTENERS =[
  ea.l.saveForRun(
    of = ea.acc.lastBest();
    processor = f.composition(
      of = f.pairerFirst(of = ea.f.solution(); second = m.supplier(of = s.a.dummyBox()));
      then = sim.biTaskVideoBuilder(
        drawer = sim.drawer(framer = sim.staticFramer(minX = 4; maxX = 36; minY = 3; maxY = 24); actions = true);
        task = $SIMULATION
      )
    );
    path = $basePath + "best-vs-box-{solver.name}-{solver.opponentsSelector.name}-{randomGenerator.seed:%02d}.mp4";
    kCondition = $VIDEO
  )
]